{% extends "base.html" %}
{% block title %}Friends{% endblock %}

{% block content %}
<div class="add-friends-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-bottom: 1.5rem;">
          {% for category, message in messages %}
            <div style="background: {% if category == 'success' %}#d4edda{% else %}#fff3cd{% endif %};
                        color: {% if category == 'success' %}#155724{% else %}#856404{% endif %};
                        border: 1px solid {% if category == 'success' %}#c3e6cb{% else %}#ffeeba{% endif %};
                        padding: 10px 15px;
                        border-radius: 6px;
                        max-width: 600px;
                        margin: 0 auto 1rem auto;
                        text-align: center;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <h2>Find Users</h2>
    <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Enter name...">
        <button onclick="searchUsers()">Search</button>
    </div>
    <ul id="searchResults" class="search-results"></ul>
        <div class="add-friends-container">
            <h2>My Friends List</h2>

            {% if current_user.friends %}
                <ul class="search-results">
                    {% for friend in current_user.friends %}
                        <li>
                            <div class="result-item">
                                <h3>{{ friend.name}}</h3>
                                <span><a href="{{ url_for('view_user_profile', user_id=friend.id) }}" class="username-link"><strong>{{ friend.name }}</strong></a></span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #ccc; text-align: center;">You have no friends yet.</p>
            {% endif %}
        </div>
    
        <div>
        <h2>Friend Requests</h2>
        {% if pending_requests %}
            <ul class="search-results">
                {% for request in pending_requests %}
                    <li>
                        <div class="result-item">
                            <h3>From {{ request.requester.name }}</h3>
                            <form method="POST" action="{{ url_for('respond_friend_request', request_id=request.request_id) }}">
                                <button name = "decision" type="submit" value = "accept">Accept</button>
                                <button name = "decision" type="submit" value="decline">Decline</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #ccc; text-align: center;">No new friend requests.</p>
        {% endif %}
        </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
function searchUsers() {
    const query = document.getElementById("searchInput").value;
    if (!query) return;

    fetch(`/search_users?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsList = document.getElementById("searchResults");
            resultsList.innerHTML = '';

            if (data.length === 0) {
                resultsList.innerHTML = '<li>No users found.</li>';
                return;
            }

            data.forEach(user => {
                const item = document.createElement('li');
                item.innerHTML = `
                    <div class="result-item">
                        <span><a href="/profile/${user.id}" class="username-link"><strong>${user.name}</strong></a></span>
                        <form method="POST" action="/add_friends/${user.id}">
                            <button type="submit">Add Friend</button>
                        </form>
                    </div>`;
                resultsList.appendChild(item);
            });
        });
}

document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("searchInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchUsers();
        }
    });
});
</script>
{% endblock %}