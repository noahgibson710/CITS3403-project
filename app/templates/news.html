{% extends "base.html" %}

{% block content %}
  <section class="news-section">
    <h1>Peer-to-Peer News Sharing</h1>
    <p class="subtext">Here is where you will find results other users have shared with you</p>

    <!-- Search bar to find users to share with -->
    <form class="search-form" onsubmit="return false;" autocomplete="off">
      <input type="text" id="user-search" placeholder="Search for users to share with..." />
      <ul id="search-results" class="dropdown-menu"></ul>

      <label for="post-selector">Select one of your macro results to share:</label>
      <input type="text" id="post-selector" placeholder="Select your macro post..." readonly />
      <ul id="post-results" class="dropdown-menu"></ul>

      <button type="button" id="share-button">Share</button>
    </form>

    <!-- Outbound sharing -->
    <div class="news-container">
      <h2>Posts You've Shared</h2>
      <div class="news-post" id="sent-posts">
        <p>Loading your shared posts...</p>
      </div>
    </div>
  </section>

  <section class="news-section">
    <h2>Inbound Posts Shared With You</h2>
    <div class="news-container">
      <div class="news-post" id="received-posts">
        <p>Loading posts shared with you...</p>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const input = document.getElementById('user-search');
    const results = document.getElementById('search-results');
    const postInput = document.getElementById('post-selector');
    const postResults = document.getElementById('post-results');

    // User search dropdown
    input.addEventListener('input', () => {
      const query = input.value.trim();
      results.innerHTML = '';

      if (query.length < 2) {
        results.style.display = 'none';
        return;
      }

      fetch(`/search_users?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            results.style.display = 'none';
            return;
          }

          data.forEach(user => {
            const item = document.createElement('li');
            item.className = 'dropdown-item';
            item.textContent = user.name;

            item.onclick = () => {
              input.value = user.name;
              results.innerHTML = '';
              results.style.display = 'none';
            };

            results.appendChild(item);
          });

          results.style.display = 'block';
        });
    });

    // Macro post dropdown
    postInput.addEventListener('focus', () => {
      fetch('/my_macroposts')
        .then(res => res.json())
        .then(data => {
          postResults.innerHTML = '';
          if (data.length === 0) {
            const emptyItem = document.createElement('li');
            emptyItem.className = 'dropdown-item';
            emptyItem.textContent = 'No posts available.';
            postResults.appendChild(emptyItem);
          } else {
            data.forEach(post => {
              const item = document.createElement('li');
              item.className = 'dropdown-item';
              item.textContent = `Age ${post.age}, ${post.weight}kg, ${post.height}cm – TDEE: ${post.tdee}`;
              item.onclick = () => {
                postInput.value = `Post #${post.id} – Age ${post.age}, TDEE ${post.tdee}`;
                postResults.innerHTML = '';
                postResults.style.display = 'none';
              };
              postResults.appendChild(item);
            });
          }
          postResults.style.display = 'block';
        });
    });

    // Hide dropdowns when clicking outside
    document.addEventListener('click', function (e) {
      if (!input.contains(e.target) && !results.contains(e.target)) {
        results.innerHTML = '';
        results.style.display = 'none';
      }
      if (!postInput.contains(e.target) && !postResults.contains(e.target)) {
        postResults.innerHTML = '';
        postResults.style.display = 'none';
      }
    });


document.getElementById('share-button').addEventListener('click', () => {
  const user = input.value.trim();
  const postMatch = postInput.value.match(/Post #(\d+)/);

  if (!user) {
    alert('Please select a user to share with.');
    return;
  }

  if (!postMatch) {
    alert('Please select a macro post to share.');
    return;
  }

  const postId = postMatch[1];

  fetch('/share_post', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ receiver: user, post_id: postId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(`Error: ${data.error}`);
    } else {
      alert(`Post shared with ${user}!`);
      fetchSharedPosts(); // Refresh shared posts
    }
  })
  .catch(err => {
    alert('Failed to share post.');
    console.error(err);
  });
});

    // Fetch shared posts from backend
    function fetchSharedPosts() {
      fetch('/shared_posts')
        .then(res => res.json())
        .then(data => {
          const sentContainer = document.getElementById('sent-posts');
          const receivedContainer = document.getElementById('received-posts');

          sentContainer.innerHTML = data.sent.length
            ? data.sent.map(p => `<p>Shared with <strong>${p.shared_with}</strong>: Age ${p.age}, TDEE ${p.tdee}</p>`).join('')
            : '<p>You haven’t shared anything yet.</p>';

          receivedContainer.innerHTML = data.received.length
            ? data.received.map(p => `<p>From <strong>${p.shared_with}</strong>: Age ${p.age}, TDEE ${p.tdee}</p>`).join('')
            : '<p>No shared results yet. When someone shares with you, they\'ll appear here!</p>';
        });
    }

    // Initial fetch on page load
    fetchSharedPosts();
  </script>
{% endblock %}
