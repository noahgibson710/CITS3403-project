{% extends "base.html" %}

{% block title %}Profile Page{% endblock %}

{% block content %}
<div class="profile-container">
    <header class="profile-header">
        <h1>Profile Page</h1>
    </header>

    <section class="profile-info">
        <div style="display:flex; flex-direction:column; align-items:center; margin-bottom: 2em;">
            <h2 style="font-size:2rem; font-weight:bold; color:#ff6b6b; margin-bottom:0.5em;">{{ user.name }}</h2>
            <div class="profile-card">
                <img src="{{ url_for('static', filename='profile_pics/' + user.profile_picture) }}" alt="Profile Picture" class="profile-picture">
                <button onclick="document.getElementById('profile-picture-form').style.display='block'" class="profile-btn update-btn">Update Profile Picture</button>
            </div>
            <!-- Profile Picture Upload Form -->
            <div id="profile-picture-form" style="display:none; margin-top: 1em; background:#181818; padding:2em; border-radius:16px; box-shadow:0 0 10px #ff6b6b33; max-width:400px; margin-left:auto; margin-right:auto;">
                <form method="POST" action="{{ url_for('update_profile_picture') }}" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <fieldset class="form-group">
                        <legend class="border-bottom mb-4" style="color:#ff6b6b;">Update Profile Picture</legend>
                        <div class="form-group">
                            <!-- Remove or change the label below -->
                            <!-- {{ form.picture.label(style="color:#ff6b6b;") }} -->
                            {{ form.picture(class="form-control-file", style="color:#ffb3b3;") }}
                            {% if form.picture.errors %}
                                {% for error in form.picture.errors %}
                                    <span class="text-danger">{{ error }}</span></br>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </fieldset>
                    <div class="form-group" style="display:flex; gap:1em; justify-content:center; flex-wrap:wrap;">
                        {{ form.submit(class="btn btn-outline-info") }}
                        {% if user.profile_picture != 'placeholder-profile.jpg' %}
                        <form method="POST" action="{{ url_for('delete_profile_picture') }}">
                            <button type="submit" class="btn btn-outline-danger">Delete Picture</button>
                        </form>
                        {% endif %}
                        <button type="button" onclick="document.getElementById('profile-picture-form').style.display='none'" class="btn btn-outline-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        <div style="display:flex; justify-content:center; gap:1em; margin-bottom:1em;">
            <div style="background:#222; color:#ffb3b3; padding:0.5em 1em; border-radius:8px; font-weight:bold;">Username: <span style="color:#ff6b6b;">{{ user.name }}</span></div>
            <div style="background:#222; color:#ffb3b3; padding:0.5em 1em; border-radius:8px; font-weight:bold;">Email: <span style="color:#ff6b6b;">{{ user.email }}</span></div>
        </div>
        <form action="{{ url_for('update_profile_info') }}" method="POST" style="margin-top: 1em; background:#181818; padding:2em; border-radius:16px; box-shadow:0 0 10px #ff6b6b33; max-width:400px; margin-left:auto; margin-right:auto;">
            <label for="gender" style="color:#ff6b6b; font-weight:bold;">Gender:</label>
            <select id="gender" name="gender" required style="width:100%; margin-bottom:1em; padding:0.5em; font-size:1rem; box-sizing:border-box;">
                <option value="" disabled {% if not user.gender %}selected{% endif %}>Select your gender</option>
                <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
            </select>
            <label for="age" style="color:#ff6b6b; font-weight:bold;">Age (21â€“70):</label>
            <input type="number" id="age" name="age" min="21" max="70" value="{{ user.age if user.age else '' }}" required style="width:100%; margin-bottom:1em; padding:0.5em; font-size:1rem; box-sizing:border-box;">
            <button type="submit" style="margin-top: 1em; background-color: #4CAF50; color: white; font-weight: bold; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; width:100%; font-size:1.1rem;">Save Gender & Age</button>
        </form>
    </section>
    

    <section class="graph">
        <h3>Macro History Graph</h3>
        <div id="macro-history-graph" style="width: 100%; height: 400px; margin-bottom: 20px;"></div>

    </section>

    
    
    <section class="macro-history">
        <h3>Macro History</h3>
        {% if macro_posts %}
            <ul>
                {% for post in macro_posts %}
                    <li>
                        <strong>Date:</strong> {{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}<br>
                        <strong>Weight:</strong> {{ post.weight }} kg<br>
                        <strong>BMR:</strong> {{ post.bmr }} cal/day,
                        <strong>TDEE:</strong> {{ post.tdee }} cal/day
                        <form action="{{ url_for('delete_macro_post', post_id=post.id) }}" method="POST" style="inline">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this entry?');">Delete</button>
                        </form>
                        <form action="{{ url_for('create_feed_post', post_id = post.id) }}" method="POST" style="inline">
                            {% if macro_posts %}
                                <input type="hidden" name="content" value="Latest Macro Stats - Weight: {{ macro_posts[-1].weight }}kg, BMR: {{ macro_posts[-1].bmr }}, TDEE: {{ macro_posts[-1].tdee }}">
                            {% else %}
                                <input type="hidden" name="content" value="No macro stats available.">
                            {% endif %}
                                    <button type="submit">Share to Community Feed</button>
                        </form>
                        
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You haven't saved any results yet.</p>
        {% endif %}
    </section>
</div>

<div class="theme-toggle">
    <label class="theme-label" for="theme-switch">Toggle Theme</label>
    <label class="switch">
        <input type="checkbox" id="theme-switch" onchange="toggleTheme()" />
        <span class="slider"></span>
    </label>
</div>

{% if request.args.get('updated') %}
<div id="profile-update-success" style="position:fixed; top:30px; left:50%; transform:translateX(-50%); background:#4CAF50; color:white; padding:1em 2em; border-radius:10px; font-size:1.2rem; z-index:1000; box-shadow:0 2px 10px #0008;">
    Profile updated successfully!
</div>
<script>
    setTimeout(function() {
        var msg = document.getElementById('profile-update-success');
        if (msg) msg.style.display = 'none';
    }, 2500);
</script>
{% endif %}

<style>
.profile-card {
    background: #181818;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2em 2em 2em 2em;
    border-radius: 24px;
    box-shadow: 0 2px 16px #ff6b6b22;
    margin-bottom: 2em;
    width: 340px;
    max-width: 90vw;
}
.profile-picture {
    display: block;
    margin: 0 auto 1.2em auto;
    border: 3px solid #ff6b6b;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    box-shadow: 0 2px 8px #0005;
}
.profile-btn {
    font-weight: bold;
    border-radius: 8px;
    width: 220px;
    padding: 0.7em 0;
    margin-bottom: 1em;
    box-shadow: 0 2px 8px #ff6b6b33;
    transition: background 0.2s, color 0.2s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}
.update-btn {
    background: #ff6b6b;
    color: #fff;
}
.update-btn:hover {
    background: #ffb3b3;
    color: #222;
}
.delete-btn {
    background: #2d1111;
    color: #ff6b6b;
    margin-bottom: 0;
    margin-top: 0.5em;
    font-size: 1rem;
}
.delete-btn:hover {
    background: #ff6b6b;
    color: #fff;
}
.profile-card form {
    width: 100%;
    display: flex;
    justify-content: center;
    background: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin-bottom: 0 !important;
}
</style>

{% endblock %}

{% block scripts %}
<script>
    const macroData = {
        dates: [{% for post in macro_posts[::-1] %}"{{ post.timestamp.strftime('%Y-%m-%d') }}"{% if not loop.last %}, {% endif %}{% endfor %}],
        weights: [{% for post in macro_posts[::-1] %}{{ post.weight }}{% if not loop.last %}, {% endif %}{% endfor %}],
        bmr: [{% for post in macro_posts[::-1] %}{{ post.bmr }}{% if not loop.last %}, {% endif %}{% endfor %}],
        tdee: [{% for post in macro_posts[::-1] %}{{ post.tdee }}{% if not loop.last %}, {% endif %}{% endfor %}]
    };
</script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
    Highcharts.chart('macro-history-graph', {
        chart: {
            type: 'line'
        },
        title: {
            text: 'Macro History'
        },
        xAxis: {
            categories: macroData.dates,
            title: { text: 'Date' }
        },
        yAxis: {
            title: {
                text: 'Values' 
            }
        },
        series: [
            {
                name: 'Weight (kg)',
                data: macroData.weights
            },
            {
                name: 'BMR (cal/day)',
                data: macroData.bmr
            },
            {
                name: 'TDEE (cal/day)',
                data: macroData.tdee
            }
        ]
    });
</script>

{% endblock %}
